!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t():"function"==typeof define&&define.amd?define([],t):"object"==typeof exports?exports["video/download"]=t():e["video/download"]=t()}(globalThis,(()=>(()=>{var e,t,i={942:(e,t,i)=>{"use strict";i.d(t,{vx:()=>h,oD:()=>u,EA:()=>w,E:()=>b,En:()=>g,WO:()=>y});var n=i(416),o=i(847);const s=coreApis.utils.sort;var a=i(179),r=i(161),d=i(397),l=i(395),c=i(24),p=i(905);const u={video:".mp4",audio:".m4a",flacAudio:".flac"};let h=function(e){return e.Avc="AVC/H.264",e.Hevc="HEVC/H.265",e.Av1="AV1",e}({});const f=e=>{const{options:t}=(0,p.getComponentSettings)("downloadVideo");return"video"===e?t.dashVideoExtension:"audio"===e?t.dashAudioExtension:"flacAudio"===e?t.dashFlacAudioExtension:u[e]??".m4s"},m=e=>({url:e.downloadUrl,allUrls:[e.downloadUrl,...e.backupUrls??[]],length:e.duration,size:Math.trunc(e.bandWidth*e.duration/8),extension:f(e.type)}),v=async function(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};const{codec:i=h.Avc,filters:u}=t,f={video:()=>!0,audio:()=>!0,...u},{aid:v,cid:g,quality:y}=e,b={avid:v,cid:g,qn:y?.value??"",otype:"json",fourk:1,fnver:0,fnval:4048},w=r.bangumiUrls.some((e=>(0,o.matchUrlPattern)(e))),x=w?(0,c.i)((0,o.formData)(b)):(0,c.y)((0,o.formData)(b)),_=await(0,n.bilibiliApi)((0,n.getJsonWithCredentials)(x),"获取视频链接失败");if(!_.dash)throw new Error("此视频没有 dash 格式, 请改用其他格式.");const C=a.allQualities.find((e=>e.value===_.quality)),{duration:k,video:I,audio:A,dolby:V,flac:S}=_.dash,D=e=>{switch(e){case 12:return h.Hevc;case 13:return h.Av1;default:return h.Avc}},E=I.filter((e=>e.id===C.value)).map((e=>({type:"video",videoCodec:D(e.codecid),quality:C,width:e.width,height:e.height,codecs:e.codecs,codecId:e.codecid,bandWidth:e.bandwidth,frameRate:e.frameRate,backupUrls:(e.backupUrl||e.backup_url||[]).map((e=>e.replace("http:","https:"))),downloadUrl:(e.baseUrl||e.base_url||"").replace("http:","https:"),duration:k}))).filter((e=>f.video(e))),O=function(e){return{type:arguments.length>1&&void 0!==arguments[1]?arguments[1]:"audio",bandWidth:e.bandwidth,codecs:e.codecs,codecId:e.codecid??0,backupUrls:(e.backupUrl||e.backup_url||[]).map((e=>e.replace("http:","https:"))),downloadUrl:(e.baseUrl||e.base_url||"").replace("http:","https:"),duration:k}},U=(A||[]).map((e=>O(e))).filter((e=>f.audio(e)));V&&U.push(...V.audio?.map((e=>O(e)))??[]),S&&U.push(...S.audio?[O(S.audio,"flacAudio")]:[]);const T=(e=>{const{videoDashes:t,audioDashes:i,videoCodec:n}=e,o=[];if(0!==t.length){const e=e=>e.videoCodec===n;if(t.some(e)){const i=t.filter(e).sort((0,s.ascendingSort)((e=>e.bandWidth)))[0];o.push(m(i))}else o.push(m(t.sort((0,s.ascendingSort)((e=>e.bandWidth)))[0]))}if(0!==i.length){const e=i.sort((0,s.descendingSort)((e=>e.bandWidth)))[0];o.push(m(e))}return o})({audioDashes:U,videoDashes:E,videoCodec:i}),P=(()=>{const e=e=>_.accept_quality.filter((t=>null===e||I.some((i=>i.id===t&&D(i.codecid)===e)))).map((e=>a.allQualities.find((t=>t.value===e)))).filter((e=>void 0!==e)),t=e(i);if(t.length>0)return t;const{options:n}=(0,p.getComponentSettings)("downloadVideo"),o=e(n.dashCodecFallback);return o.length>0?o:e(null)})(),N=new l._({input:e,jsonData:_,fragments:T,qualities:P,currentQuality:C});return(0,d.X)(e,N),N},g={name:"video.dash.avc",displayName:"dash (AVC/H.264)",description:"音画分离的 mp4 格式, 编码为 H.264, 体积较大, 兼容性较好. 下载后可以合并为单个 mp4 文件. 如果视频源没有此编码, 则会回退到设置中设定的 DASH 回退编码.",downloadVideoInfo:async e=>v(e,{codec:h.Avc})},y={name:"video.dash.hevc",displayName:"dash (HEVC/H.265)",description:"音画分离的 mp4 格式, 编码为 H.265, 体积中等, 兼容性较差. 下载后可以合并为单个 mp4 文件. 如果视频源没有此编码, 则会回退到设置中设定的 DASH 回退编码.",downloadVideoInfo:async e=>v(e,{codec:h.Hevc})},b={name:"video.dash.av1",displayName:"dash (AV1)",description:"音画分离的 mp4 格式, 编码为 AV1, 体积较小, 兼容性中等. 下载后可以合并为单个 mp4 文件. 如果视频源没有此编码, 则会回退到设置中设定的 DASH 回退编码.",downloadVideoInfo:async e=>v(e,{codec:h.Av1})},w={name:"video.dash.audio",displayName:"dash (仅音频)",description:"仅下载视频中的音频轨道.",downloadVideoInfo:async e=>v(e,{filters:{video:()=>!1}})}},24:(e,t,i)=>{"use strict";i.d(t,{i:()=>o,y:()=>n});const n=e=>`https://api.bilibili.com/x/player/playurl?${e}`,o=e=>`https://api.bilibili.com/pgc/player/web/playurl?${e}`},397:(e,t,i)=>{"use strict";i.d(t,{X:()=>o});var n=i(179);const o=(e,t)=>{e.quality&&t.currentQuality.value!==e.quality.value&&(e.allowQualityDrop?console.warn(`'${e.title}' 不支持选择的清晰度${e.quality.displayName}, 已降级为${t.currentQuality.displayName}`):(e=>{if(n.vipRequiredQualities.find((t=>t.value===e)))throw new Error("您选择的清晰度需要大会员, 请更改清晰度后重试.");if(n.loginRequiredQualities.find((t=>t.value===e)))throw new Error("您选择的清晰度需要先登录.");throw new Error("获取下载链接失败, 请尝试更换清晰度或更换格式.")})(e.quality.value))}},395:(e,t,i)=>{"use strict";i.d(t,{C:()=>d,_:()=>r});const n=coreApis.download;var o=i(82),s=i(121);function a(e,t,i){return(t=function(e){var t=function(e,t){if("object"!=typeof e||!e)return e;var i=e[Symbol.toPrimitive];if(void 0!==i){var n=i.call(e,t||"default");if("object"!=typeof n)return n;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===t?String:Number)(e)}(e,"string");return"symbol"==typeof t?t:t+""}(t))in e?Object.defineProperty(e,t,{value:i,enumerable:!0,configurable:!0,writable:!0}):e[t]=i,e}class r{constructor(e){a(this,"input",void 0),a(this,"fragments",void 0),a(this,"qualities",void 0),a(this,"currentQuality",void 0),a(this,"jsonData",void 0),Object.assign(this,e)}get totalSize(){return lodash.sumBy(this.fragments,(e=>e.size))}get totalLength(){return lodash.sumBy(this.fragments,(e=>e.length))}get titledFragments(){return this.fragments.map(((e,t)=>{const i=this.fragments.filter((t=>t.extension===e.extension)).length>1?` - ${(0,o.formatNumber)(t+1,this.fragments.length)}`:"";return{...e,title:`${this.input.title}${i}${e.extension}`}}))}}class d{constructor(e){this.infos=e,a(this,"inputs",[]),a(this,"extraAssets",[]),a(this,"extraOnlineAssets",[]),this.inputs=e.map((e=>e.input))}get isSingleVideo(){return this.inputs.length<2}async downloadExtraAssets(){console.log("[downloadExtraAssets]",this.extraAssets);const e=`${(0,s.getFriendlyTitle)(!1)}.zip`,{infos:t}=this,i=(await Promise.all([...this.extraAssets,...this.extraOnlineAssets].map((e=>{let{asset:i,instance:n}=e;return i.getAssets(t,n)})))).flat();await new n.DownloadPackage(i).emit(e)}}},203:(e,t,i)=>{var n=i(955)((function(e){return e[1]}));n.push([e.id,".download-video-panel {\n  background-color: #fff;\n  color: black;\n  border-radius: 8px;\n  border: 1px solid #8882;\n  box-sizing: border-box;\n  box-shadow: 0 4px 12px 0 rgba(0, 0, 0, 0.05);\n  font-size: 12px;\n  padding: 6px;\n  top: 100px;\n  left: 50%;\n  transform: translateX(-50%) scale(0.95);\n  transition: 0.2s ease-out;\n  z-index: 1000;\n  width: 320px;\n  height: calc(100vh - 200px);\n  display: flex;\n  flex-direction: column;\n}\nbody.dark .download-video-panel {\n  box-shadow: 0 4px 12px 0 rgba(0, 0, 0, 0.2);\n}\nbody.dark .download-video-panel {\n  background-color: var(--be-color-card-bg, #282828);\n  color: var(--be-color-text-title, #eee);\n}\nbody.dark .download-video-panel {\n  background-color: var(--be-color-popup-bg, #222);\n}\n.download-video-panel.open {\n  transform: translateX(-50%);\n}\n.download-video-panel .be-textbox,\n.download-video-panel .be-textarea {\n  flex-grow: 1;\n}\n.download-video-panel-header {\n  display: flex;\n  align-items: center;\n  border-bottom: 1px solid #8882;\n  padding: 6px 0;\n  margin: 0 6px;\n}\n.download-video-panel-header .title {\n  font-size: 16px;\n  font-weight: 600;\n  flex-grow: 1;\n  margin: 0 8px;\n}\n.download-video-panel-header .be-button {\n  padding: 4px;\n}\n.download-video-panel-content {\n  overflow: auto;\n  scrollbar-width: none !important;\n  overscroll-behavior: contain;\n  display: flex;\n  align-items: stretch;\n  flex-direction: column;\n  flex: 1 0 0;\n  padding: 12px 6px;\n  align-items: flex-start;\n}\n.download-video-panel-content::-webkit-scrollbar {\n  height: 0 !important;\n  width: 0 !important;\n}\n.download-video-panel-content > :not(:first-child) {\n  margin-top: 12px;\n}\n.download-video-panel .download-video-config-item {\n  display: flex;\n  align-items: center;\n}\n.download-video-panel .download-video-config-item .download-video-config-title {\n  margin-right: 8px;\n}\n.download-video-panel .download-video-config-item.error {\n  color: #e57373;\n}\n.download-video-panel .download-video-config-section {\n  align-self: stretch;\n}\n.download-video-panel .download-video-config-description {\n  color: #888d;\n  margin-top: 4px;\n}\n.download-video-panel .download-video-config-description a {\n  color: var(--theme-color-70);\n}\n.download-video-panel-footer {\n  display: flex;\n  align-items: center;\n  border-top: 1px solid #8882;\n  padding: 6px 0;\n  margin: 0 6px;\n  justify-content: center;\n}\n.download-video-panel .run-download {\n  font-size: 13px;\n  padding: 6px 12px;\n}",""]),e.exports=n},626:(e,t,i)=>{var n=i(955)((function(e){return e[1]}));n.push([e.id,".episodes-picker-header {\n  display: flex;\n  align-items: center;\n}\n.episodes-picker-checked-ratio {\n  flex-grow: 1;\n  margin-left: 4px;\n}\n.episodes-picker-actions {\n  display: flex;\n  align-items: center;\n}\n.episodes-picker-actions .be-button {\n  padding: 4px;\n}\n.episodes-picker-actions .be-button.invert-selection .be-icon {\n  font-size: 14px;\n}\n.episodes-picker-actions .be-button.select-all .be-icon, .episodes-picker-actions .be-button.deselect-all .be-icon {\n  transform: translateY(1px);\n}\n.episodes-picker-items {\n  max-height: 400px;\n  overflow: auto;\n}\n.episodes-picker-items:not(:empty) {\n  margin-top: 4px;\n  border: 1px solid #8884;\n  border-radius: 6px;\n}\n.episodes-picker-items .be-check-box {\n  padding: 2px 6px;\n}\n.episodes-picker-items .episode-duration {\n  margin-right: 4px;\n  text-align: right;\n  flex: 1 1 0;\n  opacity: 0.5;\n}\n.episodes-picker-empty {\n  display: flex;\n  align-items: center;\n  justify-content: center;\n  padding: 4px 0;\n}",""]),e.exports=n},67:(e,t,i)=>{var n=i(955)((function(e){return e[1]}));n.push([e.id,".single-video-info.download-video-config-section {\n  position: relative;\n  height: 125px;\n  display: flex;\n  align-items: center;\n  justify-content: center;\n}\n.single-video-info.download-video-config-section img {\n  height: 125px;\n  object-fit: contain;\n  border-radius: 8px;\n}\n.single-video-info.download-video-config-section img.shadow {\n  position: absolute;\n  filter: blur(8px) brightness(0.8);\n  transform: scaleY(0.95) translateY(4px);\n  z-index: -1;\n  opacity: 0.3;\n}",""]),e.exports=n},955:e=>{"use strict";
// eslint-disable-next-line func-names
e.exports=function(e){var t=[];return t.toString=function(){return this.map((function(t){var i=e(t);return t[2]?"@media ".concat(t[2]," {").concat(i,"}"):i})).join("")},
// eslint-disable-next-line func-names
t.i=function(e,i,n){"string"==typeof e&&(
// eslint-disable-next-line no-param-reassign
e=[[null,e,""]]);var o={};if(n)for(var s=0;s<this.length;s++){
// eslint-disable-next-line prefer-destructuring
var a=this[s][0];null!=a&&(o[a]=!0)}for(var r=0;r<e.length;r++){var d=[].concat(e[r]);n&&o[d[0]]||(i&&(d[2]?d[2]="".concat(i," and ").concat(d[2]):d[2]=i),t.push(d))}},t}},991:(e,t,i)=>{"use strict";var n,o=function(){return void 0===n&&(
// @see http://browserhacks.com/#hack-e71d8692f65334173fee715c222cb805
// @see https://github.com/webpack-contrib/style-loader/issues/177
n=Boolean(window&&document&&document.all&&!window.atob)),n},s=function(){var e={};return function(t){if(void 0===e[t]){var i=document.querySelector(t);if(window.HTMLIFrameElement&&i instanceof window.HTMLIFrameElement)try{i=i.contentDocument.head}catch(e){i=null}e[t]=i}return e[t]}}(),a=[];function r(e){for(var t=-1,i=0;i<a.length;i++)if(a[i].identifier===e){t=i;break}return t}function d(e,t){for(var i={},n=[],o=0;o<e.length;o++){var s=e[o],d=t.base?s[0]+t.base:s[0],l=i[d]||0,c="".concat(d," ").concat(l);i[d]=l+1;var p=r(c),u={css:s[1],media:s[2],sourceMap:s[3]};-1!==p?(a[p].references++,a[p].updater(u)):a.push({identifier:c,updater:v(u,t),references:1}),n.push(c)}return n}function l(e){var t=document.createElement("style"),n=e.attributes||{};if(void 0===n.nonce){var o=i.nc;o&&(n.nonce=o)}if(Object.keys(n).forEach((function(e){t.setAttribute(e,n[e])})),"function"==typeof e.insert)e.insert(t);else{var a=s(e.insert||"head");if(!a)throw new Error("Couldn't find a style target. This probably means that the value for the 'insert' parameter is invalid.");a.appendChild(t)}return t}var c,p=(c=[],function(e,t){return c[e]=t,c.filter(Boolean).join("\n")});function u(e,t,i,n){var o=i?"":n.media?"@media ".concat(n.media," {").concat(n.css,"}"):n.css;if(e.styleSheet)e.styleSheet.cssText=p(t,o);else{var s=document.createTextNode(o),a=e.childNodes;a[t]&&e.removeChild(a[t]),a.length?e.insertBefore(s,a[t]):e.appendChild(s)}}function h(e,t,i){var n=i.css,o=i.media,s=i.sourceMap;if(o?e.setAttribute("media",o):e.removeAttribute("media"),s&&"undefined"!=typeof btoa&&(n+="\n/*# sourceMappingURL=data:application/json;base64,".concat(btoa(unescape(encodeURIComponent(JSON.stringify(s))))," */")),e.styleSheet)e.styleSheet.cssText=n;else{for(;e.firstChild;)e.removeChild(e.firstChild);e.appendChild(document.createTextNode(n))}}var f=null,m=0;function v(e,t){var i,n,o;if(t.singleton){var s=m++;i=f||(f=l(t)),n=u.bind(null,i,s,!1),o=u.bind(null,i,s,!0)}else i=l(t),n=h.bind(null,i,t),o=function(){!function(e){if(null===e.parentNode)return!1;e.parentNode.removeChild(e)}(i)};return n(e),function(t){if(t){if(t.css===e.css&&t.media===e.media&&t.sourceMap===e.sourceMap)return;n(e=t)}else o()}}e.exports=function(e,t){(t=t||{}).singleton||"boolean"==typeof t.singleton||(t.singleton=o());var i=d(e=e||[],t);return function(e){if(e=e||[],"[object Array]"===Object.prototype.toString.call(e)){for(var n=0;n<i.length;n++){var o=r(i[n]);a[o].references--}for(var s=d(e,t),l=0;l<i.length;l++){var c=r(i[l]);0===a[c].references&&(a[c].updater(),a.splice(c,1))}i=s}}}},839:(e,t,i)=>{"use strict";i.r(t),i.d(t,{default:()=>K});var n=function(){var e=this,t=e._self._c;e._self._setupProxy;return t("VPopup",{staticClass:"download-video-panel",attrs:{fixed:"","trigger-element":e.triggerElement},model:{value:e.open,callback:function(t){e.open=t},expression:"open"}},[t("div",{staticClass:"download-video-panel-header"},[t("VIcon",{attrs:{icon:"mdi-download"}}),e._v(" "),t("div",{staticClass:"title"},[e._v("下载视频")]),e._v(" "),t("VButton",{attrs:{type:"transparent",title:"关闭"},on:{click:function(t){e.open=!1}}},[t("VIcon",{attrs:{icon:"mdi-close",size:20}})],1)],1),e._v(" "),t("div",{staticClass:"download-video-panel-content"},[e.selectedInput?t("div",{staticClass:"download-video-config-item"},[t("div",{staticClass:"download-video-config-title"},[e._v("输入源:")]),e._v(" "),t("VDropdown",{attrs:{items:e.inputs},model:{value:e.selectedInput,callback:function(t){e.selectedInput=t},expression:"selectedInput"}})],1):e._e(),e._v(" "),0===e.inputs.length?t("div",{staticClass:"download-video-config-item error"},[e._v("\n      没有匹配的输入源, 请确保安装了适合此页面的插件.\n    ")]):e._e(),e._v(" "),e.selectedInput&&e.selectedInput.component?t(e.selectedInput.component,{ref:"inputOptions",tag:"component"}):e._e(),e._v(" "),e.selectedApi?t("div",{staticClass:"download-video-config-item"},[t("div",{staticClass:"download-video-config-title"},[e._v("格式:")]),e._v(" "),t("VDropdown",{attrs:{items:e.apis},model:{value:e.selectedApi,callback:function(t){e.selectedApi=t},expression:"selectedApi"}})],1):e._e(),e._v(" "),e.selectedApi&&e.selectedApi.description?t("div",{staticClass:"download-video-config-description",domProps:{innerHTML:e._s(e.selectedApi.description)}}):e._e(),e._v(" "),e.selectedQuality?t("div",{staticClass:"download-video-config-item"},[t("div",{staticClass:"download-video-config-title"},[e._v("清晰度:")]),e._v(" "),t("VDropdown",{attrs:{items:e.filteredQualities},on:{change:function(t){return e.saveSelectedQuality()}},model:{value:e.selectedQuality,callback:function(t){e.selectedQuality=t},expression:"selectedQuality"}})],1):e._e(),e._v(" "),!e.testData.multiple&&e.selectedQuality?[e.testData.videoInfo?t("div",{staticClass:"download-video-config-description"},[e._v("\n        预计大小: "+e._s(e.formatFileSize(e.testData.videoInfo.totalSize))+"\n      ")]):e._e(),e._v(" "),null===e.testData.videoInfo?t("div",{staticClass:"download-video-config-description"},[e._v("\n        正在计算大小\n      ")]):e._e()]:e._e(),e._v(" "),t("div",{staticClass:"download-video-config-item"},[t("div",{staticClass:"download-video-config-title"},[e._v("下载地址偏好:")]),e._v(" "),t("VDropdown",{attrs:{items:e.urlTypeOptions},model:{value:e.preferredUrlType,callback:function(t){e.preferredUrlType=t},expression:"preferredUrlType"}})],1),e._v(" "),t("div",{staticClass:"download-video-config-description"},[e._v("\n      当视频有多个源时, 配置优先使用的源, 各类视频源区别请参考\n      "),t("a",{attrs:{href:"https://github.com/the1812/Bilibili-Evolved/issues/3234#issuecomment-1504764774",target:"_blank"}},[e._v("此处")])]),e._v(" "),e._l(e.assetsWithOptions,(function(e){return t(e.component,{key:e.name,ref:"assetsOptions",refInFor:!0,tag:"component",attrs:{name:e.name}})})),e._v(" "),e.selectedOutput?t("div",{staticClass:"download-video-config-item"},[t("div",{staticClass:"download-video-config-title"},[e._v("输出方式:")]),e._v(" "),t("VDropdown",{attrs:{items:e.outputs},model:{value:e.selectedOutput,callback:function(t){e.selectedOutput=t},expression:"selectedOutput"}})],1):e._e(),e._v(" "),e.selectedOutput&&e.selectedOutput.description?t("div",{staticClass:"download-video-config-description",domProps:{innerHTML:e._s(e.selectedOutput.description)}}):e._e(),e._v(" "),e.selectedOutput&&e.selectedOutput.component?t(e.selectedOutput.component,{ref:"outputOptions",tag:"component"}):e._e()],2),e._v(" "),t("div",{staticClass:"download-video-panel-footer"},[t("VButton",{staticClass:"run-download",attrs:{type:"primary",disabled:!e.canStartDownload},on:{click:function(t){return e.startDownload(e.$refs.outputOptions,e.selectedOutput)}}},[e._v("\n      开始\n    ")])],1)])};n._withStripped=!0;var o=i(905),s=i(847);const a=coreApis.utils.log;var r=i(82);const d=coreApis.ui,l=coreApis.pluginApis.data;var c=i(179);const p=coreApis.toast;var u=i(121),h=i(416),f=i(161),m=function(){var e=this,t=e._self._c;e._self._setupProxy;return t("div",{staticClass:"episodes-picker download-video-config-section"},[t("div",{staticClass:"episodes-picker-header"},[t("div",{staticClass:"episodes-picker-title"},[e._v("选集:")]),e._v(" "),t("div",{staticClass:"episodes-picker-checked-ratio"},[e._v("\n      "+e._s(e.checkedRatio)+"\n    ")]),e._v(" "),t("div",{staticClass:"episodes-picker-actions"},[t("VButton",{staticClass:"select-all",attrs:{title:"全选",type:"transparent"},on:{click:function(t){e.forEachItem((e=>e.isChecked=!0))}}},[t("VIcon",{attrs:{size:16,icon:"mdi-checkbox-multiple-marked-circle"}})],1),e._v(" "),t("VButton",{staticClass:"deselect-all",attrs:{title:"全不选",type:"transparent"},on:{click:function(t){e.forEachItem((e=>e.isChecked=!1))}}},[t("VIcon",{attrs:{size:16,icon:"mdi-checkbox-multiple-blank-circle-outline"}})],1),e._v(" "),t("VButton",{staticClass:"invert-selection",attrs:{title:"反选",type:"transparent"},on:{click:function(t){e.forEachItem((e=>e.isChecked=!e.isChecked))}}},[t("VIcon",{attrs:{size:16,icon:"mdi-circle-slice-4"}})],1)],1)]),e._v(" "),t("div",{staticClass:"episodes-picker-items"},[0===e.episodeItems.length?t("div",{staticClass:"episodes-picker-empty"},[t("VEmpty")],1):e._e(),e._v(" "),e._l(e.episodeItems,(function(i,n){return t("div",{key:i.key,staticClass:"episodes-picker-item"},[t("CheckBox",{attrs:{"icon-position":"left","data-aid":i.inputItem.aid,"data-cid":i.inputItem.cid,"data-bvid":i.inputItem.bvid},nativeOn:{click:function(t){return e.shiftSelect(t,i,n)}},model:{value:i.isChecked,callback:function(t){e.$set(i,"isChecked",t)},expression:"item.isChecked"}},[t("span",{staticClass:"episode-title"},[e._v("\n          "+e._s(i.title)+"\n        ")]),e._v(" "),i.durationText?t("span",{staticClass:"episode-duration"},[e._v("\n          "+e._s(i.durationText)+"\n        ")]):e._e()])],1)}))],2)])};m._withStripped=!0;const v=Vue.extend({components:{VButton:d.VButton,VIcon:d.VIcon,CheckBox:d.CheckBox,VEmpty:d.VEmpty},props:{api:{type:Function,required:!0}},data:()=>({episodeItems:[],maxCheckedItems:32,lastCheckedEpisodeIndex:-1}),computed:{checkedRatio(){return`(${this.episodeItems.filter((e=>e.isChecked)).length}/${this.episodeItems.length})`},inputItems(){return this.episodeItems.map((e=>e.inputItem))},checkedInputItems(){return this.episodeItems.filter((e=>e.isChecked)).map((e=>e.inputItem))}},created(){this.getEpisodeItems()},methods:{shiftSelect(e,t,i){e.shiftKey&&-1!==this.lastCheckedEpisodeIndex?e.shiftKey&&-1!==this.lastCheckedEpisodeIndex&&(this.episodeItems.slice(Math.min(this.lastCheckedEpisodeIndex,i)+1,Math.max(this.lastCheckedEpisodeIndex,i)).forEach((e=>{e.isChecked=!e.isChecked})),this.lastCheckedEpisodeIndex=i,e.preventDefault()):this.lastCheckedEpisodeIndex=i},forEachItem(e){this.episodeItems.forEach(e)},async getEpisodeItems(){this.episodeItems.length>0||(this.episodeItems=await this.api(this))}}});var g=i(991),y=i.n(g),b=i(626),w=i.n(b),x={insert:"head",singleton:!1};y()(w(),x);w().locals;var _=i(678);const C=(0,_.A)(v,m,[],!1,null,null,null).exports,k=e=>Vue.extend({computed:{checkedInputItems(){return this.$refs.picker.checkedInputItems}},render:t=>t(C,{props:{api:e},ref:"picker"})}),I={name:"bangumi.batch",displayName:"当前番剧 (多P)",match:f.bangumiUrls,batch:!0,getInputs:async e=>e?.checkedInputItems??[],component:async()=>k((async e=>{const t=dq('script[type="application/ld+json"]');if(!t)return(0,a.logError)("获取番剧数据失败: 无法找到 Metadata"),[];const i=JSON.parse(t.innerHTML.trim()),n=lodash.get(i,"itemListElement.0.url",null);if(null===n)return(0,a.logError)("获取番剧数据失败: 无法找到 metaUrl"),[];const s=n.match(/play\/ss(\d+)/)?.[1];if(void 0===s)return(0,a.logError)("获取番剧数据失败: 无法解析 Season ID"),[];const d=await(0,h.getJson)(`https://api.bilibili.com/pgc/web/season/section?season_id=${s}`);if(0!==d.code)return(0,a.logError)(`获取番剧数据失败: 无法获取番剧集数列表, message=${d.message}`),[];const l=[...d.result.main_section.episodes,...d.result.section?.flatMap((e=>e.episodes))??[]];return l.map((c=l.length,(t,i)=>{const n=t.long_title?t.title:(i+1).toString(),s=t.long_title?t.long_title:t.title;return{key:t.cid,title:`${n} - ${s}`,isChecked:i<e.maxCheckedItems,inputItem:{aid:t.aid,cid:t.cid,title:(0,u.formatTitle)((0,o.getGeneralSettings)().batchFilenameFormat,!1,{ep:s,cid:t.cid,aid:t.aid,n:(0,r.formatNumber)(parseFloat(n),c)??n}),allowQualityDrop:!0}}}));var c}))},A={name:"video.batch",displayName:"当前视频 (多P)",match:f.videoUrls,batch:!0,getInputs:async e=>e?.checkedInputItems??[],component:async()=>k((async e=>{const{aid:t}=unsafeWindow,i=`https://api.bilibili.com/x/web-interface/view?aid=${t}`,n=await(0,h.getJsonWithCredentials)(i);if(0!==n.code)return(0,a.logError)(`获取视频选集列表失败, message = ${n.message}`),[];const{pages:s,owner:d,pubdate:l}=n.data;if(void 0===s)return(0,a.logError)("获取视频选集列表失败, 没有找到选集信息."),[];const c=(0,u.getTitleVariablesFromDate)(new Date(1e3*l));return s.map(((i,n)=>({key:i.cid,title:`P${i.page} ${i.part}`,isChecked:n<e.maxCheckedItems,durationText:(0,r.formatDuration)(i.duration),inputItem:{allowQualityDrop:!0,title:(0,u.formatTitle)((0,o.getGeneralSettings)().batchFilenameFormat,!1,{n:(0,r.formatNumber)(i.page,s.length),cid:i.cid,ep:i.part,user:d?.name,userID:d?.mid?.toString(),publishYear:c.year,publishMonth:c.month,publishDay:c.day,publishHour:c.hour,publishMinute:c.minute,publishSecond:c.second,publishMillisecond:c.millisecond}),cid:i.cid,aid:t}})))}))},V={name:"video.seasonBatch",displayName:"当前视频 (合集)",match:f.videoUrls,batch:!0,getInputs:async e=>e?.checkedInputItems??[],component:async()=>k((async e=>{const{aid:t,bvid:i}=unsafeWindow,n=`https://api.bilibili.com/x/web-interface/wbi/view/detail?bvid=${i}&aid=${t}`,s=await(0,h.getJsonWithCredentials)(n);if(0!==s.code)return(0,a.logError)(`获取视频合集列表失败, message = ${s.message}`),[];const d=lodash.get(s,"data.View.owner",{}),l=lodash.get(s,"data.View.ugc_season.sections",[]);if(0===l.length)return[];const c=lodash.sumBy(l,(e=>e.episodes.length));return l.flatMap(((t,i)=>{const{episodes:n=[]}=t;return n.map(((t,n)=>{const s=n+lodash.sumBy(l.slice(0,i),(e=>e.episodes.length)),a=t.cid,p=s+1,h=`P${p} ${t.title}`,f=(0,u.getTitleVariablesFromDate)(new Date(1e3*t.arc.pubdate));return{key:a,title:h,isChecked:s<e.maxCheckedItems,durationText:(0,r.formatDuration)(t.arc.duration),inputItem:{allowQualityDrop:!0,title:(0,u.formatTitle)((0,o.getGeneralSettings)().batchFilenameFormat,!1,{n:(0,r.formatNumber)(p,c),title:t.page.part,cid:t.cid,aid:t.aid,bvid:t.bvid,ep:t.title,user:d.name,userID:d.mid?.toString(),publishYear:f.year,publishMonth:f.month,publishDay:f.day,publishHour:f.hour,publishMinute:f.minute,publishSecond:f.second,publishMillisecond:f.millisecond}),cid:t.cid,aid:t.aid}}}))}))}))},S={name:"video",displayName:"当前视频",match:f.videoUrls,getInputs:async()=>[{aid:unsafeWindow.aid,cid:unsafeWindow.cid,title:(0,u.getFriendlyTitle)(!0)}],component:()=>Promise.resolve().then(i.bind(i,901)).then((e=>e.default))};var D=i(942),E=i(397),O=i(395),U=i(24);const T=(e,t)=>{const i=e=>t.length>e?t[e]:t[t.length-1];return{fragments:e.durl.map(((e,t)=>({length:e.length,size:e.size,url:e.url,allUrls:[e.url,...e.backup_url??[]],extension:i(t)}))),qualities:e.accept_quality.map((e=>c.allQualities.find((t=>t.value===e)))).filter((e=>void 0!==e)),currentQuality:c.allQualities.find((t=>t.value===e.quality))}},P={name:"video.flv",displayName:"flv",description:"使用 flv 格式下载, 兼容 H.264 编码. 支持的清晰度相比于 dash 会少很多.",downloadVideoInfo:e=>(async e=>{const{aid:t,cid:i,quality:n}=e,o={avid:t,cid:i,qn:n?.value?.toString()??"",otype:"json"},a=f.bangumiUrls.some((e=>(0,s.matchUrlPattern)(e))),r=a?(0,U.i)(new URLSearchParams(o).toString()):(0,U.y)(new URLSearchParams(o).toString()),d=await(0,h.bilibiliApi)((0,h.getJsonWithCredentials)(r),"获取视频链接失败"),l=new O._({input:e,jsonData:d,...T(d,[".flv"])});return(0,E.X)(e,l),l})(e)},N=coreApis.runtimeLibrary,M={name:"steamSaver",displayName:"StreamSaver",description:'使用 StreamSaver 输出到本地文件, 下载过程中请勿关闭页面. 注意: 需要浏览器允许来自 jimmywarting.github.io (StreamSaver 的网站) 的第三方 cookie, 详细原因见 <a href="https://github.com/jimmywarting/StreamSaver.js?#how-does-it-work" target="blank">How does it work</a>, 否则弹出的链接点击后会没有反应.',runAction:async e=>{const t=await N.StreamSaverLibrary,i=e.infos.flatMap((e=>e.titledFragments)),n=p.Toast.show(i.map(((e,t)=>`<a class="link" data-index="${t}">${e.title}</a>`)).join("\n"),"下载视频"),o=await n.element;dqa(o,"a[data-index]").forEach((e=>{e.addEventListener("click",(async()=>{const{index:n}=e.dataset,{title:o,url:s,size:a}=i[n],r=t.createWriteStream(o,{size:a}),d=await fetch(s);await d.body.pipeTo(r)}))}))}};
/* spell-checker: disable */let $=function(e){return e.Mirror="mirror",e.UPOS="upos",e.BCache="bcache",e.MCDN="mcdn",e.Other="other",e}({});const j=
// spell-checker: disable-next-line
/^upos-([0-9a-z]+?)-mirror([0-9a-z]+)\.(bilivideo\.com|akamaized\.net)$/,q=e=>{try{const{hostname:t,port:i,searchParams:n}=new URL(e);if(j.test(t))return $.Mirror;const o=n.get("os")?.toLowerCase();if("upos"===o||t.includes("upos"))return $.UPOS;if("bcache"===o)return $.BCache;const s=""!==i&&"80"!==i&&"443"!==i;return"mcdn"===o||t.includes("mcdn")||s?$.MCDN:$.Other}catch{return $.Other}},[Q]=(0,l.registerAndGetData)("downloadVideo.inputs",[S,A,V,I]),[B]=(0,l.registerAndGetData)("downloadVideo.apis",[P,D.En,D.WO,D.E,D.EA]),[H]=(0,l.registerAndGetData)("downloadVideo.assets",[]),[F]=(0,l.registerAndGetData)("downloadVideo.outputs",[M]),{basicConfig:z}=(0,o.getComponentSettings)("downloadVideo").options,W=e=>e.filter((e=>e.match?.some((e=>(0,s.matchUrlPattern)(e)))??!0)),L=[{displayName:"Mirror",name:$.Mirror},{displayName:"UPOS",name:$.UPOS},{displayName:"BCache",name:$.BCache},{displayName:"MCDN / PCDN",name:$.MCDN}],R=Vue.extend({components:{VPopup:d.VPopup,VButton:d.VButton,VDropdown:d.VDropdown,VIcon:d.VIcon,SwitchBox:d.SwitchBox},props:{triggerElement:{required:!0}},data(){const e=z.output,t=z.preferredUrlType;return console.log({lastPreferredUrlType:t,optionValue:t??$.Mirror}),{open:!1,busy:!1,testData:{videoInfo:null,multiple:!1},assets:H,qualities:[],selectedQuality:void 0,inputs:[],selectedInput:void 0,apis:[],selectedApi:void 0,outputs:F,selectedOutput:F.find((t=>t.name===e))||F[0],urlTypeOptions:L,preferredUrlType:t??L.find((e=>e.name===$.Mirror))}},computed:{assetsWithOptions(){return this.assets.filter((e=>e.component))},filteredQualities(){return 0===this.qualities.length?c.allQualities:this.qualities},canStartDownload(){if(this.busy||!this.open)return!1;return!Object.entries(this).filter((e=>{let[t]=e;return t.startsWith("selected")})).some((e=>{let[,t]=e;return!t}))}},watch:{selectedInput(e){void 0!==e&&this.updateTestVideoInfo()},selectedApi(e){void 0!==e&&(this.updateTestVideoInfo(),z.api=e.name)},selectedOutput(e){void 0!==e&&(z.output=e.name)},preferredUrlType(e){void 0!==e&&(z.preferredUrlType=e)}},mounted(){coreApis.observer.videoChange((()=>{this.selectedInput=void 0,this.selectedApi=void 0;const e=W(Q);this.inputs=e,this.selectedInput=e[0];const t=W(B);this.apis=t;const i=t.find((e=>e.name===z.api));this.selectedApi=i||t[0]}))},methods:{formatFileSize:r.formatFileSize,saveSelectedQuality(){const e=this.selectedQuality;void 0!==e&&(z.quality=e.value,this.updateTestVideoInfo())},async getVideoItems(){const e=this.selectedInput;return await e.getInputs(this.$refs.inputOptions)},async updateTestVideoInfo(){if(!this.selectedInput||!this.selectedApi)return;this.testData.videoInfo=null;const e=this.selectedInput,t=e.getTestInput?.()??{aid:unsafeWindow.aid,cid:unsafeWindow.cid,title:(0,u.getFriendlyTitle)(!0)};console.log("[updateTestVideoInfo]",t),this.testData.multiple=e.batch;const i=this.selectedApi;try{const e=await i.downloadVideoInfo(t);this.qualities=e.qualities;if((!this.selectedQuality||!e.qualities.some((e=>e.value===this.selectedQuality.value)))&&(this.selectedQuality=e.qualities[0],z.quality)){const[t]=e.qualities.filter((e=>e.value<=z.quality));t&&(this.selectedQuality=t)}t.quality=this.selectedQuality;const n=await i.downloadVideoInfo(t);this.testData.videoInfo=n,console.log("[qualityVideoInfo]",n)}catch(e){console.error("[updateTestVideoInfo] failed",e),this.testData.videoInfo=void 0}},async startDownload(e,t){try{this.busy=!0;const i=this.selectedInput,n=this.selectedApi,o=await i.getInputs(this.$refs.inputOptions);if(0===o.length)return void p.Toast.info("未接收到视频, 如果输入源支持批量, 请至少选择一个视频.","下载视频",3e3);o.forEach((e=>{e.quality=this.selectedQuality}));const s=await Promise.all(o.map((e=>n.downloadVideoInfo(e))));if(0===s.length||0===lodash.sumBy(s,(e=>e.fragments.length)))return void p.Toast.info("未接收到可下载数据, 请检查输入源和格式是否适用于当前视频.","下载视频",3e3);s.forEach((e=>{e.fragments.forEach((e=>{if(void 0!==this.preferredUrlType){const t=e.allUrls.find((e=>q(e)===this.preferredUrlType));e.url=void 0!==t?t:(e=>{const t={[$.Mirror]:0,[$.UPOS]:1,[$.BCache]:2,[$.MCDN]:3,[$.Other]:4};return[...e].sort(((e,i)=>{const n=q(e),o=q(i);return t[n]-t[o]}))})(e.allUrls)[0]}}))}));const a=new O.C(s);H.forEach((e=>{(e?.getUrls?a.extraOnlineAssets:a.extraAssets).push({asset:e,instance:this.$refs.assetsOptions.find((t=>t.$attrs.name===e.name))})})),await t.runAction(a,e),await a.downloadExtraAssets()}catch(e){(0,a.logError)(e)}finally{this.busy=!1}}}}),G=R;var J=i(203),X=i.n(J),Y={insert:"head",singleton:!1};y()(X(),Y);X().locals;const K=(0,_.A)(G,n,[],!1,null,null,null).exports},655:(e,t,i)=>{"use strict";i.r(t),i.d(t,{default:()=>a});var n=function(){var e=this,t=e._self._c;e._self._setupProxy;return t("div",{staticClass:"multiple-widgets"},[t("DefaultWidget",{ref:"button",attrs:{name:"下载视频",icon:"mdi-download"},on:{mouseover:function(t){return e.createDownloadPanel()},click:function(t){return e.toggleDownloadPanel()}}})],1)};let o;n._withStripped=!0;const s=Vue.extend({components:{DefaultWidget:coreApis.ui.DefaultWidget},methods:{async createDownloadPanel(){if(!o){const e=document.createElement("div");document.body.appendChild(e);const t=await Promise.resolve().then(i.bind(i,839)).then((e=>e.default));o=new t({propsData:{triggerElement:this.$refs.button}}).$mount(e)}},async toggleDownloadPanel(){o&&(o.open=!o.open)}}});const a=(0,i(678).A)(s,n,[],!1,null,null,null).exports},901:(e,t,i)=>{"use strict";i.r(t),i.d(t,{default:()=>u});var n=function(){var e=this,t=e._self._c;e._self._setupProxy;return t("div",{staticClass:"single-video-info download-video-config-section"},[e.imageUrl?t("img",{staticClass:"shadow",attrs:{src:e.imageUrl}}):e._e(),e._v(" "),e.imageUrl?t("img",{attrs:{src:e.imageUrl}}):e._e()])};n._withStripped=!0;const o=coreApis.componentApis.video.videoCover,s=coreApis.observer,a=Vue.extend({data:()=>({imageUrl:""}),created(){(0,s.videoChange)((async()=>{const{aid:e}=unsafeWindow;this.imageUrl=await(0,o.getVideoCoverUrlByAid)(e)}))}});var r=i(991),d=i.n(r),l=i(67),c=i.n(l),p={insert:"head",singleton:!1};d()(c(),p);c().locals;const u=(0,i(678).A)(a,n,[],!1,null,null,null).exports},678:(e,t,i)=>{"use strict";function n(e,t,i,n,o,s,a,r){var d,l="function"==typeof e?e.options:e;if(t&&(l.render=t,l.staticRenderFns=i,l._compiled=!0),n&&(l.functional=!0),s&&(l._scopeId="data-v-"+s),a?(d=function(e){(e=e||this.$vnode&&this.$vnode.ssrContext||this.parent&&this.parent.$vnode&&this.parent.$vnode.ssrContext)||"undefined"==typeof __VUE_SSR_CONTEXT__||(e=__VUE_SSR_CONTEXT__),o&&o.call(this,e),e&&e._registeredComponents&&e._registeredComponents.add(a)},l._ssrRegister=d):o&&(d=r?function(){o.call(this,(l.functional?this.parent:this).$root.$options.shadowRoot)}:o),d)if(l.functional){l._injectStyles=d;var c=l.render;l.render=function(e,t){return d.call(t),c(e,t)}}else{var p=l.beforeCreate;l.beforeCreate=p?[].concat(p,d):[d]}return{exports:e,options:l}}i.d(t,{A:()=>n})},292:e=>{function t(e){var t=new Error("Cannot find module '"+e+"'");throw t.code="MODULE_NOT_FOUND",t}t.keys=()=>[],t.resolve=t,t.id=292,e.exports=t},623:e=>{"use strict";e.exports="在功能面板中添加下载视频支持. 请注意:\n- 不能下载超出账号权限的视频, 例如非大会员下载大会员清晰度视频, 或者大陆地区网络下载港澳台地区番剧, 都是不可以的.\n- 请勿短时间进行大量下载, 以免遭到 b 站 IP 封禁.\n\n在使用视频 (非番剧) 批量下载时, 文件的批量命名格式中可以使用以下额外变量:\n- `user`: UP 主用户名\n- `userID`: UP 主用户 ID\n- 视频发布时间:\n  - `publishYear`\n  - `publishMonth`\n  - `publishDay`\n  - `publishHour`\n  - `publishMinute`\n  - `publishSecond`\n  - `publishMillisecond`\n"},416:e=>{"use strict";e.exports=coreApis.ajax},179:e=>{"use strict";e.exports=coreApis.componentApis.video.videoQuality},905:e=>{"use strict";e.exports=coreApis.settings},82:e=>{"use strict";e.exports=coreApis.utils.formatters},121:e=>{"use strict";e.exports=coreApis.utils.title},161:e=>{"use strict";e.exports=coreApis.utils.urls},847:e=>{"use strict";e.exports=coreApis.utils}},n={};function o(e){var t=n[e];if(void 0!==t)return t.exports;var s=n[e]={id:e,exports:{}};return i[e](s,s.exports,o),s.exports}o.n=e=>{var t=e&&e.__esModule?()=>e.default:()=>e;return o.d(t,{a:t}),t},t=Object.getPrototypeOf?e=>Object.getPrototypeOf(e):e=>e.__proto__,o.t=function(i,n){if(1&n&&(i=this(i)),8&n)return i;if("object"==typeof i&&i){if(4&n&&i.__esModule)return i;if(16&n&&"function"==typeof i.then)return i}var s=Object.create(null);o.r(s);var a={};e=e||[null,t({}),t([]),t(t)];for(var r=2&n&&i;"object"==typeof r&&!~e.indexOf(r);r=t(r))Object.getOwnPropertyNames(r).forEach((e=>a[e]=()=>i[e]));return a.default=()=>i,o.d(s,a),s},o.d=(e,t)=>{for(var i in t)o.o(t,i)&&!o.o(e,i)&&Object.defineProperty(e,i,{enumerable:!0,get:t[i]})},o.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),o.r=e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},o.nc=void 0;var s={};return(()=>{"use strict";o.d(s,{component:()=>a});const e=coreApis.componentApis.define,t=coreApis.spinQuery;var i=o(942);const n=(0,e.defineOptionsMetadata)({basicConfig:{defaultValue:{},displayName:"基础配置",hidden:!0},dashVideoExtension:{defaultValue:i.oD.video,displayName:"DASH 视频扩展名"},dashAudioExtension:{defaultValue:i.oD.audio,displayName:"DASH 普通音频扩展名"},dashFlacAudioExtension:{defaultValue:i.oD.flacAudio,displayName:"DASH FLAC 音频扩展名"},dashCodecFallback:{defaultValue:i.vx.Avc,dropdownEnum:i.vx,displayName:"DASH 回退编码"}}),a=(0,e.defineComponentMetadata)({name:"downloadVideo",displayName:"下载视频",entry:none,reload:none,unload:none,widget:{component:()=>Promise.resolve().then(o.bind(o,655)).then((e=>e.default)),condition:()=>(0,t.hasVideo)()},tags:[componentsTags.video],options:n,commitHash:"89fb2c637b9efb1cf418b68a45a4f2255a7601f9",coreVersion:"2.10.6",description:(()=>{const e=o(292);return{...Object.fromEntries(e.keys().map((t=>[t.match(/index\.(.+)\.md$/)[1],e(t)]))),"zh-CN":()=>Promise.resolve().then(o.t.bind(o,623,17)).then((e=>e.default))}})()})})(),s=s.component})()));