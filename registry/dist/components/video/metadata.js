!function(t,e){"object"==typeof exports&&"object"==typeof module?module.exports=e():"function"==typeof define&&define.amd?define([],e):"object"==typeof exports?exports["video/metadata"]=e():t["video/metadata"]=e()}(globalThis,(()=>(()=>{"use strict";var t={500:(t,e,i)=>{i.d(e,{component:()=>p,U:()=>l,D:()=>c});var n=i(253);const o=coreApis.spinQuery;var a=i(5);const s=coreApis.utils.urls;var r=i(804),d=i(324);const c="保存视频元数据",l="saveVideoMetadata",u=[{name:"WakelessSloth56",link:"https://github.com/WakelessSloth56"},{name:"LainIO24",link:"https://github.com/LainIO24"}],p=(0,n.defineComponentMetadata)({name:l,displayName:c,description:"保存视频元数据（标题、描述、UP、章节等）",author:u,tags:[componentsTags.video],entry:none,urlInclude:s.videoAndBangumiUrls,options:d.f,widget:{condition:o.hasVideo,component:()=>Promise.resolve().then(i.bind(i,163)).then((t=>t.default))},plugin:{displayName:`下载视频 - ${c}支持`,author:u,setup:t=>{let{addData:e}=t;e("downloadVideo.assets",(async t=>{t.push({name:l,displayName:c,getAssets:async(t,e)=>{const{type:i,enabled:n}=e;if(n){const e=a.Toast.info("获取视频元数据中...",c),n=[];for(const e of t)n.push({name:`${e.input.title}.${i}.txt`,data:await(0,r.V)(i,e.input.aid,e.input.cid),options:{}});return e.message="完成！",e.duration=1e3,n}return[]},component:()=>Promise.resolve().then(i.bind(i,438)).then((t=>t.default))})}))}},commitHash:"c2a3ec9c33f2b153d78ebe47ea2fd6e76e040032",coreVersion:"2.10.4"})},804:(t,e,i)=>{i.d(e,{V:()=>b});const n=coreApis.componentApis.video.videoInfo,o=coreApis.ajax,a=coreApis.meta;var s=i(905),r=i(5),d=i(500),c=i(324);function l(t){return lodash.toString(t).replace(/[=;#\\\n]/g,(t=>`\\${t}`))}function u(t){return t.map((t=>`${t.tag_name}(${t.tag_id})`))}function p(t,e,i){return(e=function(t){var e=function(t,e){if("object"!=typeof t||!t)return t;var i=t[Symbol.toPrimitive];if(void 0!==i){var n=i.call(t,e||"default");if("object"!=typeof n)return n;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===e?String:Number)(t)}(t,"string");return"symbol"==typeof e?e:e+""}(e))in t?Object.defineProperty(t,e,{value:i,enumerable:!0,configurable:!0,writable:!0}):t[e]=i,t}class f{constructor(t,e){p(this,"aid",void 0),p(this,"cid",void 0),p(this,"basic",void 0),p(this,"viewPoints",void 0),p(this,"tags",{}),p(this,"page",void 0),p(this,"quality",void 0),p(this,"bangumi",void 0),this.aid=parseInt(t),this.cid=parseInt(e),this.basic=new n.VideoInfo(t)}async fetch(){await this.basic.fetchInfo(),this.page=this.basic.pages.filter((t=>t.cid===this.cid))[0];const t=await(0,o.bilibiliApi)((0,o.getJsonWithCredentials)(`//api.bilibili.com/x/player/wbi/v2?aid=${this.aid}&cid=${this.cid}`));this.viewPoints=lodash.get(t,"view_points",[]);const e=await(0,o.bilibiliApi)((0,o.getJsonWithCredentials)(`//api.bilibili.com/x/web-interface/view/detail/tag?aid=${this.aid}&cid=${this.cid}`)),i=lodash.groupBy(e,"tag_type");if(this.tags.tag=i.old_channel,this.tags.topic=i.topic,this.tags.bgm=i.bgm,this.basic.redirectUrl){const t=parseInt(this.basic.redirectUrl.match(/ep(\d+)/)?.[1]??"");t&&(this.bangumi=await n.BangumiInfo.byEpisodeId(t).fetchInfo(),(0,s.getComponentSettings)(d.U).options.convertBangumiSkips&&0===this.viewPoints.length&&(this.viewPoints=function(t,e){const i=[],{op:n,ed:o}=t,a=n.start>=0&&n.end>0,s=o.start>n.end&&o.end<=e;return a&&n.start>0&&i.push({from:0,to:n.start,content:""}),a&&i.push({from:n.start,to:n.end,content:"Opening Theme"}),a&&s?i.push({from:n.end,to:o.start,content:""}):a&&!s?i.push({from:n.end,to:e,content:""}):!a&&s&&i.push({from:0,to:o.start,content:""}),s&&i.push({from:o.start,to:o.end,content:"Ending Theme"}),s&&o.end<e&&i.push({from:o.end,to:e,content:""}),i}(this.bangumi.episode.skip,this.bangumi.episode.duration)))}}}async function g(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:unsafeWindow.aid,e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:unsafeWindow.cid;const i=new f(t,e);return await i.fetch(),i}function m(t,e){return`${!(arguments.length>2&&void 0!==arguments[2])||arguments[2]?"bilibili_":""}${t}=${Array.isArray(e)?e.map(l).join(","):l(e)}`}async function h(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:unsafeWindow.aid,e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:unsafeWindow.cid;const i=await g(t,e),{basic:n}=i;console.debug(i);const{options:{fieldsMode:o}}=(0,s.getComponentSettings)(d.U),r=[";FFMETADATA1",`;generated by Bilibili-Evolved v${a.meta.compilationInfo.version}`,`;generated on ${(new Date).toLocaleString()}`,m("title",`${n.title} - ${i.page.title}`,!1),m("description",n.description,!1),m("artist",n.up.name,!1)];if(o===c.H.ALL){if(r.push(m("title",n.title),m("description",n.description),m("publish_date",new Date(1e3*n.pubdate).toLocaleString()),m("aid",n.aid),m("bvid",n.bvid),m("cid",i.page.cid),m("up_name",n.up.name),m("up_uid",n.up.uid),m("page_title",i.page.title),m("pages",n.pages.length),m("page",i.page.pageNumber),m("category_id",n.tagId),m("category_name",n.tagName)),i.tags.tag&&r.push(m("tags",u(i.tags.tag))),i.tags.topic&&r.push(m("topic",u(i.tags.topic))),i.tags.bgm&&r.push(m("bgm",i.tags.bgm.map((t=>`${t.tag_name.match(/^发现《([^》]+)》/)?.[1]??t.tag_name}(${t.music_id})`)))),i.bangumi){const t=i.bangumi;r.push(m("bangumi_media_id",t.mediaId),m("bangumi_season_id",t.seasonId),m("bangumi_season_title",t.seasonTitle),m("bangumi_series_id",t.seriesId),m("bangumi_series_title",t.seriesTitle),m("bangumi_episode_id",t.episode.epid),m("bangumi_episode_title",t.episode.title),m("bangumi_area",t.areas.map((t=>t.name))))}i.quality&&(r.push(m("quality",i.quality.value)),r.push(m("quality_label",i.quality.name)))}if(i.viewPoints.length>0)for(const t of i.viewPoints)r.push("[CHAPTER]","TIMEBASE=1/1",m("START",t.from,!1),m("END",t.to,!1),m("title",t.content,!1));const l=r.join("\n");return console.debug(l),l}async function v(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:unsafeWindow.aid,e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:unsafeWindow.cid;const{viewPoints:i}=await g(t,e);if(console.debug(i),i.length>0){const t=i.reduce(((t,e,i)=>{const n=`${i+1}`.padStart(3,"0");return[...t,`CHAPTER${n}=${new Date(1e3*e.from).toISOString().slice(11,-1)}`,`CHAPTER${n}NAME=${e.content}`]}),[]).join("\n");return console.debug(t),t}return r.Toast.info("此视频没有章节",d.D,3e3),null}async function b(t){let e;if("ogm"===t)e=v;else e=h;return e(arguments.length>1&&void 0!==arguments[1]?arguments[1]:unsafeWindow.aid,arguments.length>2&&void 0!==arguments[2]?arguments[2]:unsafeWindow.cid)}},324:(t,e,i)=>{i.d(e,{H:()=>o,f:()=>a});var n=i(253);let o=function(t){return t.ALL="全部",t.Standard="仅标准字段",t}({});const a=(0,n.defineOptionsMetadata)({fieldsMode:{defaultValue:o.ALL,displayName:"FFMETADATA 字段",dropdownEnum:o},convertBangumiSkips:{displayName:"将番剧的「跳过头尾」转换为章节",defaultValue:!0}})},438:(t,e,i)=>{i.r(e),i.d(e,{default:()=>r});var n=function(){var t=this,e=t._self._c;t._self._setupProxy;return e("div",{staticClass:"download-video-config-section"},[e("div",{staticClass:"download-video-config-item"},[e("div",[t._v("元数据：")]),t._v(" "),e("VDropdown",{attrs:{items:t.items},scopedSlots:t._u([{key:"item",fn:function({item:e}){return[t._v("\n        "+t._s(e)+"\n      ")]}}]),model:{value:t.type,callback:function(e){t.type=e},expression:"type"}})],1)])};n._withStripped=!0;var o=i(164);const a=(0,i(905).getComponentSettings)("downloadVideo").options,s=Vue.extend({components:{VDropdown:o.VDropdown},data:()=>({type:a.metadataType??"无",items:["无","ffmetadata","ogm"]}),computed:{enabled(){return"无"!==this.type}},watch:{type(t){a.metadataType=t}}});const r=(0,i(678).A)(s,n,[],!1,null,null,null).exports},163:(t,e,i)=>{i.r(e),i.d(e,{default:()=>l});var n=function(){var t=this,e=t._self._c;t._self._setupProxy;return e("div",{staticClass:"multiple-widgets"},[e("DefaultWidget",{ref:"button",attrs:{disabled:t.disabled,name:"保存视频元数据",icon:"mdi-download"},on:{click:function(e){return t.run("ffmetadata")}}}),t._v(" "),e("DefaultWidget",{attrs:{disabled:t.disabled,name:"保存视频章节",icon:"mdi-download"},on:{click:function(e){return t.run("ogm")}}})],1)};n._withStripped=!0;var o=i(164);const a=coreApis.utils.log,s=coreApis.download,r=coreApis.utils.title;var d=i(804);const c=Vue.extend({components:{DefaultWidget:o.DefaultWidget},data:()=>({disabled:!1}),methods:{async run(t){try{this.disabled=!0,s.DownloadPackage.single(`${(0,r.getFriendlyTitle)(!0)}.${t}.txt`,await(0,d.V)(t))}catch(t){(0,a.logError)(t)}finally{this.disabled=!1}}}});const l=(0,i(678).A)(c,n,[],!1,null,null,null).exports},678:(t,e,i)=>{function n(t,e,i,n,o,a,s,r){var d,c="function"==typeof t?t.options:t;if(e&&(c.render=e,c.staticRenderFns=i,c._compiled=!0),n&&(c.functional=!0),a&&(c._scopeId="data-v-"+a),s?(d=function(t){(t=t||this.$vnode&&this.$vnode.ssrContext||this.parent&&this.parent.$vnode&&this.parent.$vnode.ssrContext)||"undefined"==typeof __VUE_SSR_CONTEXT__||(t=__VUE_SSR_CONTEXT__),o&&o.call(this,t),t&&t._registeredComponents&&t._registeredComponents.add(s)},c._ssrRegister=d):o&&(d=r?function(){o.call(this,(c.functional?this.parent:this).$root.$options.shadowRoot)}:o),d)if(c.functional){c._injectStyles=d;var l=c.render;c.render=function(t,e){return d.call(e),l(t,e)}}else{var u=c.beforeCreate;c.beforeCreate=u?[].concat(u,d):[d]}return{exports:t,options:c}}i.d(e,{A:()=>n})},253:t=>{t.exports=coreApis.componentApis.define},905:t=>{t.exports=coreApis.settings},5:t=>{t.exports=coreApis.toast},164:t=>{t.exports=coreApis.ui}},e={};function i(n){var o=e[n];if(void 0!==o)return o.exports;var a=e[n]={exports:{}};return t[n](a,a.exports,i),a.exports}i.n=t=>{var e=t&&t.__esModule?()=>t.default:()=>t;return i.d(e,{a:e}),e},i.d=(t,e)=>{for(var n in e)i.o(e,n)&&!i.o(t,n)&&Object.defineProperty(t,n,{enumerable:!0,get:e[n]})},i.o=(t,e)=>Object.prototype.hasOwnProperty.call(t,e),i.r=t=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})};var n=i(500);return n=n.component})()));