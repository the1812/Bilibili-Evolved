!function(t,o){"object"==typeof exports&&"object"==typeof module?module.exports=o():"function"==typeof define&&define.amd?define([],o):"object"==typeof exports?exports["utils/download-emoticons"]=o():t["utils/download-emoticons"]=o()}(globalThis,(()=>(()=>{var t,o,e={669:(t,o,e)=>{"use strict";e.r(o),e.d(o,{default:()=>m});var n=function(){var t=this,o=t._self._c;t._self._setupProxy;return o("DefaultWidget",{attrs:{disabled:t.downloading,name:"下载up主表情包",icon:"mdi-emoticon-outline"},on:{click:function(o){return t.download()}}})};n._withStripped=!0;const r=coreApis.ui,i=coreApis.utils.log,s=coreApis.ajax;function a(t,o,e){return(o=function(t){var o=function(t,o){if("object"!=typeof t||!t)return t;var e=t[Symbol.toPrimitive];if(void 0!==e){var n=e.call(t,o||"default");if("object"!=typeof n)return n;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===o?String:Number)(t)}(t,"string");return"symbol"==typeof o?o:o+""}(o))in t?Object.defineProperty(t,o,{value:e,enumerable:!0,configurable:!0,writable:!0}):t[o]=e,t}const c=(0,i.useScopedConsole)("表情包下载");const l=coreApis.download,d=coreApis.toast,u=new class{constructor(){a(this,"apiRequest",(t=>{const o={url:t,method:"GET",responseType:"json"};return(0,s.monkey)(o)})),a(this,"getImageBlob",(async t=>{const o={url:t,method:"GET",responseType:"blob"};return(0,s.monkey)(o)}))}async getEmoticonsByRoomId(t){return await this.apiRequest(`https://api.live.bilibili.com/xlive/web-ucenter/v2/emoticon/GetEmoticons?platform=pc&room_id=${t}`)}async downloadEmoticons(t){return t.map((t=>({emoticons:t.emoticons.map((t=>{try{const o=this.getImageBlob(t.url);return{emoji:t.emoji,blob:o}}catch(o){return c.error(`下载表情 ${t.emoji} 失败:`,o),null}})),pkg_name:t.pkg_name})))}async getEmoticonsArray(t){try{let o=await this.getEmoticonsByRoomId(t);if(0===o.data.data.length){c.log("获取表情包失败，尝试获取真实roomId");const e=await this.getRealRoomId(t);o=await this.getEmoticonsByRoomId(e)}return o.data.data.slice(2)}catch(t){throw new Error("获取表情包失败")}}async batchDownload(t){const o=[];for(const e of t){const t=(async()=>{const t=[],o=e.emoticons.map((t=>t.blob));for(const e of o){const o=await e;t.push(o)}return{pkg_name:e.pkg_name,emoticons:e.emoticons.map(((o,e)=>({emoji:o.emoji,blob:t[e]})))}})();o.push(t)}return Promise.all(o)}async getRealRoomId(t){try{const o=await this.apiRequest(`https://api.live.bilibili.com/room/v1/Room/get_info?room_id=${t}`);if(0===Object.keys(o.data).length)throw new Error("获取直播间id失败");return o.data.room_id}catch(t){throw new Error("获取直播间id失败")}}};var p=function(t,o,e,n,r,i,s,a){var c,l="function"==typeof t?t.options:t;if(o&&(l.render=o,l.staticRenderFns=e,l._compiled=!0),n&&(l.functional=!0),i&&(l._scopeId="data-v-"+i),s?(c=function(t){(t=t||this.$vnode&&this.$vnode.ssrContext||this.parent&&this.parent.$vnode&&this.parent.$vnode.ssrContext)||"undefined"==typeof __VUE_SSR_CONTEXT__||(t=__VUE_SSR_CONTEXT__),r&&r.call(this,t),t&&t._registeredComponents&&t._registeredComponents.add(s)},l._ssrRegister=c):r&&(c=a?function(){r.call(this,(l.functional?this.parent:this).$root.$options.shadowRoot)}:r),c)if(l.functional){l._injectStyles=c;var d=l.render;l.render=function(t,o){return c.call(o),d(t,o)}}else{var u=l.beforeCreate;l.beforeCreate=u?[].concat(u,c):[c]}return{exports:t,options:l}}(Vue.extend({components:{DefaultWidget:r.DefaultWidget},data:()=>({downloading:!1,roomIdRegex:/^https:\/\/live\.bilibili\.com\/(?:blanc\/)?(\d+)(?:\?\.*?)?$/}),methods:{async download(){this.downloading=!0;try{const t=window.location.href;if(t.startsWith("https://live.bilibili.com/")){const o=this.roomIdRegex.exec(t)[1],e=await u.getEmoticonsArray(o);if(0===e.length)return void d.Toast.info("该up主没有专属表情包","表情包下载");const n=await u.downloadEmoticons(e),r=await u.batchDownload(n),i=new l.DownloadPackage;i.noEscape=!0;for(const t of r)if(null!==t)for(const o of t.emoticons)i.add(`${t.pkg_name}/${o.emoji}.png`,o.blob);await i.emit(`emoticons-${o}.zip`)}}catch(t){d.Toast.error("下载失败详情查看控制台","表情包下载"),(0,i.logError)(t)}finally{this.downloading=!1}}}}),n,[],!1,null,null,null);const m=p.exports},726:t=>{function o(t){var o=new Error("Cannot find module '"+t+"'");throw o.code="MODULE_NOT_FOUND",o}o.keys=()=>[],o.resolve=o,o.id=726,t.exports=o},701:t=>{"use strict";t.exports="## 下载up主专属表情包\n\n支持下载up主专属表情包，处于任意直播间页面时，下载按钮会在`功能`面板显示，以压缩包形式保存。"}},n={};function r(t){var o=n[t];if(void 0!==o)return o.exports;var i=n[t]={exports:{}};return e[t](i,i.exports,r),i.exports}o=Object.getPrototypeOf?t=>Object.getPrototypeOf(t):t=>t.__proto__,r.t=function(e,n){if(1&n&&(e=this(e)),8&n)return e;if("object"==typeof e&&e){if(4&n&&e.__esModule)return e;if(16&n&&"function"==typeof e.then)return e}var i=Object.create(null);r.r(i);var s={};t=t||[null,o({}),o([]),o(o)];for(var a=2&n&&e;"object"==typeof a&&!~t.indexOf(a);a=o(a))Object.getOwnPropertyNames(a).forEach((t=>s[t]=()=>e[t]));return s.default=()=>e,r.d(i,s),i},r.d=(t,o)=>{for(var e in o)r.o(o,e)&&!r.o(t,e)&&Object.defineProperty(t,e,{enumerable:!0,get:o[e]})},r.o=(t,o)=>Object.prototype.hasOwnProperty.call(t,o),r.r=t=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})};var i={};return(()=>{"use strict";r.d(i,{component:()=>e});const t=coreApis.componentApis.define,o=coreApis.utils.urls,e=(0,t.defineComponentMetadata)({name:"downloadEmoticons",displayName:"下载表情",tags:[componentsTags.utils,componentsTags.live],entry:none,author:{name:"Pencilqaq",link:"https://github.com/pencilqaq"},widget:{component:()=>Promise.resolve().then(r.bind(r,669)).then((t=>t.default))},urlInclude:o.liveUrls,commitHash:"474b35297b8791f00cf96b0c57786703fd40078f",coreVersion:"2.10.5",description:(()=>{const t=r(726);return{...Object.fromEntries(t.keys().map((o=>[o.match(/index\.(.+)\.md$/)[1],t(o)]))),"zh-CN":()=>Promise.resolve().then(r.t.bind(r,701,17)).then((t=>t.default))}})()})})(),i=i.component})()));