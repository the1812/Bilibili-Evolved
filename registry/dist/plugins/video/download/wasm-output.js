!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t():"function"==typeof define&&define.amd?define([],t):"object"==typeof exports?exports["video/download/wasm-output"]=t():e["video/download/wasm-output"]=t()}(globalThis,(()=>(()=>{"use strict";var e={9:(e,t,o)=>{o.r(t),o.d(t,{default:()=>d});var n=function(){var e=this,t=e._self._c;e._self._setupProxy;return e.shouldShow?t("div",{staticClass:"download-video-config-item",staticStyle:{"flex-wrap":"wrap"}},[t("div",{staticClass:"download-video-config-title"},[e._v("写入元数据：")]),e._v(" "),t("SwitchBox",{on:{change:e.saveOptions},model:{value:e.muxWithMetadata,callback:function(t){e.muxWithMetadata=t},expression:"muxWithMetadata"}}),e._v(" "),t("div",{staticClass:"download-video-config-description",staticStyle:{width:"100%"}},[e._v("\n    仅支持元数据类型「ffmetadata」\n  ")])],1):e._e()};n._withStripped=!0;const a=coreApis.ui;var i=o(905);const{options:s}=(0,i.getComponentSettings)("downloadVideo"),r={muxWithMetadata:!1,...s};var c=function(e,t,o,n,a,i,s,r){var c,d="function"==typeof e?e.options:e;if(t&&(d.render=t,d.staticRenderFns=o,d._compiled=!0),n&&(d.functional=!0),i&&(d._scopeId="data-v-"+i),s?(c=function(e){(e=e||this.$vnode&&this.$vnode.ssrContext||this.parent&&this.parent.$vnode&&this.parent.$vnode.ssrContext)||"undefined"==typeof __VUE_SSR_CONTEXT__||(e=__VUE_SSR_CONTEXT__),a&&a.call(this,e),e&&e._registeredComponents&&e._registeredComponents.add(s)},d._ssrRegister=c):a&&(c=r?function(){a.call(this,(d.functional?this.parent:this).$root.$options.shadowRoot)}:a),c)if(d.functional){d._injectStyles=c;var l=d.render;d.render=function(e,t){return c.call(t),l(e,t)}}else{var u=d.beforeCreate;d.beforeCreate=u?[].concat(u,c):[c]}return{exports:e,options:d}}(Vue.extend({components:{SwitchBox:a.SwitchBox},data(){const e=(0,i.isComponentEnabled)("saveVideoMetadata");return{shouldShow:e,muxWithMetadata:e&&r.muxWithMetadata}},methods:{saveOptions(){r.muxWithMetadata=this.muxWithMetadata,Object.assign(s,r)}}}),n,[],!1,null,null,null);const d=c.exports},905:e=>{e.exports=coreApis.settings}},t={};function o(n){var a=t[n];if(void 0!==a)return a.exports;var i=t[n]={exports:{}};return e[n](i,i.exports,o),i.exports}o.d=(e,t)=>{for(var n in t)o.o(t,n)&&!o.o(e,n)&&Object.defineProperty(e,n,{enumerable:!0,get:t[n]})},o.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),o.r=e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})};var n={};o.d(n,{plugin:()=>T,D:()=>j});const a=coreApis.toast,i=coreApis.download,s=coreApis.meta;var r=o(905);const c=coreApis.utils.formatters;function d(e,t,o){return(t=function(e){var t=function(e,t){if("object"!=typeof e||!e)return e;var o=e[Symbol.toPrimitive];if(void 0!==o){var n=o.call(e,t||"default");if("object"!=typeof n)return n;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===t?String:Number)(e)}(e,"string");return"symbol"==typeof t?t:t+""}(t))in e?Object.defineProperty(e,t,{value:o,enumerable:!0,configurable:!0,writable:!0}):e[t]=o,e}function l(e,t,o){(function(e,t){if(t.has(e))throw new TypeError("Cannot initialize the same private elements twice on an object")})(e,t),t.set(e,o)}function u(e,t,o){return e.set(p(e,t),o),o}function f(e,t){return e.get(p(e,t))}function p(e,t,o){if("function"==typeof e?e===t:e.has(t))return arguments.length<3?t:o;throw new TypeError("Private element is not present on this object")}
/* eslint-disable @typescript-eslint/naming-convention */const h=(()=>{let e=0;return()=>e++})();var m=function(e){return e.LOAD="LOAD",e.EXEC="EXEC",e.WRITE_FILE="WRITE_FILE",e.READ_FILE="READ_FILE",e.DELETE_FILE="DELETE_FILE",e.ERROR="ERROR",e.PROGRESS="PROGRESS",e}(m||{}),w=new WeakMap,g=new WeakMap,v=new WeakMap,E=new WeakMap,y=new WeakMap,b=new WeakMap;const x=coreApis.runtimeLibrary,S={cache:"cache"};async function _(e,t){return async function(){return new Promise(((e,t)=>{const o=unsafeWindow.indexedDB.open("bilibili-evolved-wasm-output",124);o.onerror=t,o.onupgradeneeded=()=>{const e=o.result;for(const t of e.objectStoreNames)e.deleteObjectStore(t);Object.values(S).forEach((t=>{e.createObjectStore(t)}))},o.onsuccess=()=>e(o.result)}))}().then((o=>new Promise(((n,a)=>{const i=o.transaction(e,t);n(i.objectStore(e)),i.onerror=a}))))}async function F(e,t,o){const n=await _(e).then((e=>async function(e,t){return new Promise(((o,n)=>{const a=e.get(t);a.onerror=n,a.onsuccess=()=>o(a.result)}))}(e,t)));if(n)return n;const a=await o(t);return await _(e,"readwrite").then((e=>async function(e,t,o){return new Promise(((n,a)=>{const i=e.put(t,o);i.onerror=a,i.onsuccess=()=>n(i.result)}))}(e,a,t))),a}function R(e){const t=[];return(o,n)=>(a,i,s)=>{t[o]=`${n}: ${function(e,t,o){const n=(0,c.formatFileSize)(e),a=t>0?` / ${(0,c.formatFileSize)(t)}`:"",i=t>0?` @ ${(0,c.formatPercent)(e/t)}`:"";let s="",r="";return t>e&&o>0&&(r=` (${(0,c.formatFileSize)(o)}/s)`,s=` - ${(0,c.formatDuration)((t-e)/o)}`),`${n}${a}${i}${r}${s}`}(a,i,s)}`,e.message=t.join("\n")}}function L(e){return e.headers.get("Content-Encoding")?-1:parseInt(e.headers.get("Content-Length"))}async function $(e,t){const o=await fetch(e);if(!o.ok)throw new Error(`${o.status} ${o.statusText}`);const n=o.body.getReader(),a=L(o);let i=0;const s=[];let r=Date.now(),c=0,d=0;
// eslint-disable-next-line no-constant-condition
for(;;){const{done:e,value:o}=await n.read();if(e)break;s.push(o),i+=o.length;const l=Date.now(),u=(l-r)/1e3;if(u>1){const e=(i-c)/u;t(i,a,e),r=l,c=i,d=e}else t(i,a,c>0?d:0)}const l=new Uint8Array(i);let u=0;for(const e of s)l.set(e,u),u+=e.length;return l}async function A(e){try{const t=await fetch(e,{method:"HEAD"});return t.ok?L(t):-1}catch(e){return-1}}async function M(e,t,o){return F(S.cache,e,(async()=>{const e=await $(t.url,o),n=await x.RuntimeLibrary.sha256(e);if(n!==t.sha256)throw new Error(`Check integrity failed from ${t.url}, expected = ${t.sha256}, actual = ${n}`);return e}))}function P(e,t){const o=new Blob([e],{type:t});return URL.createObjectURL(o)}const W=new class{constructor(){var e=this;l(this,w,null),l(this,g,{}),l(this,v,{}),l(this,E,void 0),d(this,"loaded",!1),l(this,y,(()=>{f(w,this)&&(f(w,this).onmessage=e=>{let{data:{id:t,type:o,data:n}}=e;switch(o){case m.LOAD:this.loaded=!0,f(g,this)[t](n);break;case m.EXEC:case m.WRITE_FILE:case m.READ_FILE:case m.DELETE_FILE:f(g,this)[t](n);break;case m.PROGRESS:f(E,this)&&f(E,this).call(this,n);break;case m.ERROR:f(v,this)[t](n)}delete f(g,this)[t],delete f(v,this)[t]})})),l(this,b,(function(t){let{type:o,data:n}=t,a=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[],i=arguments.length>2?arguments[2]:void 0;return f(w,e)?new Promise(((t,s)=>{const r=h();f(w,e)&&f(w,e).postMessage({id:r,type:o,data:n},a),f(g,e)[r]=t,f(v,e)[r]=s,i?.addEventListener("abort",(()=>{s(new DOMException(`Message # ${r} was aborted`,"AbortError"))}),{once:!0})})):Promise.reject(new Error("FFmpeg is not loaded"))})),d(this,"load",((e,t)=>(f(w,this)||(u(w,this,new Worker(e.workerLoadURL,{type:"classic"})),f(y,this).call(this)),f(b,this).call(this,{type:m.LOAD,data:e},void 0,t)))),d(this,"exec",(function(t){let o=arguments.length>1&&void 0!==arguments[1]?arguments[1]:-1,n=arguments.length>2?arguments[2]:void 0;return f(b,e).call(e,{type:m.EXEC,data:{args:t,timeout:o}},void 0,n)})),d(this,"terminate",(()=>{const e=Object.keys(f(v,this));for(const t of e)f(v,this)[t](new Error("FFmpeg terminated")),delete f(v,this)[t],delete f(g,this)[t];f(w,this)&&(f(w,this).terminate(),u(w,this,null),this.loaded=!1)})),d(this,"writeFile",((e,t,o)=>{const n=[];return n.push(t.buffer),f(b,this).call(this,{type:m.WRITE_FILE,data:{path:e,data:t}},n,o)})),d(this,"readFile",((e,t)=>f(b,this).call(this,{type:m.READ_FILE,data:{path:e,encoding:"binary"}},void 0,t))),d(this,"deleteFile",((e,t)=>f(b,this).call(this,{type:m.DELETE_FILE,data:{path:e}},void 0,t)))}onProgress(e){u(E,this,e)}};async function k(e,t,o,n,s){let r=arguments.length>5&&void 0!==arguments[5]?arguments[5]:1,d=arguments.length>6&&void 0!==arguments[6]?arguments[6]:1;const l=a.Toast.info("",`${j} - ${r} / ${d}`),u=R(l),[f,p]=await Promise.all([$(t,u(0,"正在下载视频流")),$(o,u(1,"正在下载音频流"))]);await W.writeFile("video",f),await W.writeFile("audio",p);const h=["-i","video","-i","audio"];n&&(await W.writeFile("ffmetadata",(new TextEncoder).encode(n)),h.push("-i","ffmetadata","-map_metadata","2"),s||h.push("-movflags","+use_metadata_tags")),h.push("-codec","copy","-f",s?"matroska":"mp4","output"),console.debug("FFmpeg commandline args:",h.join(" ")),W.onProgress((e=>{l.message=`混流中: ${(0,c.formatPercent)(e.progress)}`})),await W.exec(h);const m=await W.readFile("output"),w=new Blob([m],{type:s?"video/x-matroska":"video/mp4"});l.message="完成！",l.duration=1e3,await Promise.all([W.deleteFile("video"),W.deleteFile("audio"),W.deleteFile("output"),n?W.deleteFile("ffmetadata"):Promise.resolve()]),await i.DownloadPackage.single(e.replace(/.[^/.]+$/,"."+(s?"mkv":"mp4")),w)}async function O(e,t){W.loaded||await async function(){const e=a.Toast.info("正在加载 FFmpeg",`${j} - 初始化`),t=R(e),[o,n,i]=await Promise.all([M("ffmpeg-worker",s.meta.compilationInfo.altCdn.library.ffmpeg.worker,t(0,"正在加载 FFmpeg Worker")),M("ffmpeg-core",s.meta.compilationInfo.altCdn.library.ffmpeg.core,t(1,"正在加载 FFmpeg Core")),M("ffmpeg-wasm",s.meta.compilationInfo.altCdn.library.ffmpeg.wasm,t(2,"正在加载 FFmpeg WASM"))]);await W.load({workerLoadURL:P(o,"text/javascript"),coreURL:P(n,"text/javascript"),wasmURL:P(i,"application/wasm")}),e.message="完成！",e.close()}();const{infos:o,extraAssets:n}=e;let i;if(t){const t=[];for(const{asset:e,instance:a}of n)i||"saveVideoMetadata"!==e.name||"ffmetadata"!==a.type?t.push({asset:e,instance:a}):i=await e.getAssets(o,a);e.extraAssets=t}const{dashAudioExtension:d,dashFlacAudioExtension:l,dashVideoExtension:u}=(0,r.getComponentSettings)("downloadVideo").options;for(let e=0;e<o.length;e++){const t=o[e],[n,a]=t.titledFragments;if(2!==t.fragments.length||n.extension!==u||a.extension!==d&&a.extension!==l)throw new Error("仅支持 DASH 格式视频和音频");const[s,r]=await Promise.all([A(n.url),A(a.url)]),f=Math.max(s,n.size)+Math.max(r,a.size);if(f>2097152e3)throw new Error(`仅支持合并 2GB 内的音视频（${(0,c.formatFileSize)(f)}）`);await k(n.title,n.url,a.url,i?.[e]?.data,a.extension===l,e+1,o.length)}}const j="WASM 混流输出",C="使用 WASM 在浏览器中下载并合并音视频, 支持批量下载",T={name:"downloadVideo.outputs.wasm",displayName:`下载视频 - ${j}`,description:C,author:{name:"WakelessSloth56",link:"https://github.com/WakelessSloth56"},setup:e=>{let{addData:t}=e;t("downloadVideo.outputs",(e=>{e.push({name:"wasm",displayName:"WASM",description:`${C}。运行过程中请勿关闭页面，初次使用或清除缓存后需要加载约 30 MB 的 WASM 文件。由于浏览器限制，仅支持合并 2GB 以内的音视频。`,runAction:async(e,t)=>{try{await O(e,t.muxWithMetadata)}catch(e){a.Toast.error(String(e),j)}},component:()=>Promise.resolve().then(o.bind(o,9)).then((e=>e.default))})}))},commitHash:"6f513d77b2ea5ebb8dcc0962e857ffb9a8b32934",coreVersion:"2.10.4"};return n=n.plugin})()));